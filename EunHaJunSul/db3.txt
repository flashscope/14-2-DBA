
DROP TABLE IF EXISTS DB;
CREATE TABLE DB(
	DBID TINYINT(4) PRIMARY KEY NOT NULL,
	DBNAME CHAR(3),
	IP CHAR(15)
);

INSERT INTO DB(DBID, DBNAME, IP) VALUES(1,"DB1","127.0.0.1");
INSERT INTO DB(DBID, DBNAME, IP) VALUES(2,"DB2","127.0.0.1");
INSERT INTO DB(DBID, DBNAME, IP) VALUES(3,"DB3","127.0.0.1");
INSERT INTO DB(DBID, DBNAME, IP) VALUES(4,"DB4","127.0.0.1");

DROP TABLE IF EXISTS USER2DB;
CREATE TABLE USER2DB(
	UID INT(11) PRIMARY KEY auto_increment,
	GID TINYINT(4),
	DBID TINYINT(4)
);



DROP PROCEDURE SP_AddUser;
DELIMITER $$
CREATE PROCEDURE SP_AddUser(
out ouid int,
out ogid tinyint,
out odbid tinyint
)
BEGIN
START TRANSACTION;
INSERT INTO USER2DB(GID,DBID) VALUES(0,0);
SET ouid = LAST_INSERT_ID();
SET ogid = ouid % 4 + 1;
SET odbid = ogid % 2 + 1;
UPDATE USER2DB set gid = ogid, dbid = odbid where uid = ouid;
COMMIT;
END $$

DELIMITER ;


DROP TABLE IF EXISTS SHIP;
CREATE TABLE SHIP(
	SID INT(11) PRIMARY KEY auto_increment,
	UID INT(11),
	GID TINYINT(4),
	ATK INT(11)
);

DROP TABLE IF EXISTS USER;
CREATE TABLE USER(
	UID INT(11) PRIMARY KEY NOT NULL,
	GID TINYINT(4)
);


DROP PROCEDURE SP_AddShips;
DELIMITER $$
CREATE PROCEDURE SP_AddShips(
in iuid int,
in igid tinyint
)

BEGIN
DECLARE A INT;
INSERT INTO USER(UID,GID) VALUES(iuid,igid);
SET A = 0;
WHILE A < 10 DO
INSERT INTO SHIP(UID, GID, ATK) VALUES(iuid, igid, ROUND((RAND() * (100-5))+5) );
SET A = A + 1;
END WHILE;
END $$

DELIMITER ;



DROP PROCEDURE SP_GET_USER_DATA;
DELIMITER $$
CREATE PROCEDURE SP_GET_USER_DATA(
out ouid int,
out ogid tinyint,
out odbid tinyint
)
BEGIN
SELECT UID,GID,DBID INTO ouid,ogid,odbid FROM USER2DB ORDER BY RAND() limit 1;
END $$
DELIMITER ;





DROP TABLE IF EXISTS GALAXY;
CREATE TABLE GALAXY(
	GID TINYINT(4) PRIMARY KEY NOT NULL,
	NAME VARCHAR(16),
	HP INT(11)
);
INSERT INTO GALAXY(GID, NAME, HP) VALUES(1,"GALAXY1",10000);
INSERT INTO GALAXY(GID, NAME, HP) VALUES(2,"GALAXY2",10000);
INSERT INTO GALAXY(GID, NAME, HP) VALUES(3,"GALAXY3",10000);
INSERT INTO GALAXY(GID, NAME, HP) VALUES(4,"GALAXY4",10000);

DROP PROCEDURE SP_ATTACK_GALAXY;
DELIMITER $$
CREATE PROCEDURE SP_ATTACK_GALAXY(
in igid tinyint,
in iatk int,
out ohp int
)
BEGIN
START TRANSACTION;
UPDATE GALAXY set HP=HP-iatk where GID = igid;
SELECT HP INTO ohp FROM GALAXY where GID = igid;
COMMIT;
END $$


DELIMITER ;

